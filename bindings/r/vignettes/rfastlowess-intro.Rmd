---
title: "Introduction to rfastlowess"
author: "Amir Valizadeh"
date: "`r Sys.Date()`"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Introduction to rfastlowess}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Overview

`rfastlowess` is a high-performance R package for LOWESS (Locally Weighted
Scatterplot Smoothing) built on a Rust backend. It provides significant speed
improvements over standard R implementations while offering advanced features
like robustness iterations, confidence intervals, and streaming processing.

## What is LOWESS?

LOWESS is a nonparametric regression method that fits smooth curves through
scatterplot by fitting weighted polynomials at each point using nearby data.
Key advantages include:

- **No parametric assumptions**: Adapts to local data structure
- **Robustness**: Handles outliers through iterative reweighting
- **Flexibility**: Works with irregular sampling and missing regions
- **Uncertainty quantification**: Provides confidence and prediction intervals

## Installation

```{r installation, eval=FALSE}
# From R-universe (pre-built binaries, no Rust required)
install.packages("rfastlowess", repos = "https://thisisamirv.r-universe.dev")

# From source (requires Rust)

devtools::install_github("thisisamirv/rfastlowess")
```

# Basic Usage

## Simple Smoothing

```{r basic_example}
library(rfastlowess)

# Generate example data
set.seed(42)
x <- seq(0, 10, length.out = 100)
y <- sin(x) + rnorm(100, sd = 0.3)

# Basic smoothing
result <- fastlowess(x, y, fraction = 0.3)

# Plot
plot(x, y, pch = 16, col = "gray", main = "Basic LOWESS Smoothing")
lines(result$x, result$y, col = "red", lwd = 2)
```

## Robust Smoothing

For data with outliers, use robustness iterations:

```{r robust_example}
# Add outliers
y_outliers <- y
outlier_idx <- sample(1:100, 10)
y_outliers[outlier_idx] <- y_outliers[outlier_idx] + rnorm(10, mean = 0, sd = 2)

# Robust smoothing
result_robust <- fastlowess(x, y_outliers, fraction = 0.3, iterations = 5)

# Compare
plot(x, y_outliers, pch = 16, col = "gray", main = "Robust LOWESS")
lines(result$x, result$y, col = "blue", lwd = 2, lty = 2)
lines(result_robust$x, result_robust$y, col = "red", lwd = 2)
legend("topright", c("Clean data", "With outliers"),
  col = c("blue", "red"), lwd = 2, lty = c(2, 1)
)
```

# Biological Applications

## Genomic Data Smoothing

LOWESS is commonly used for smoothing genomic data such as copy number
variation, methylation profiles, or ChIP-seq signals.

```{r genomic_example}
# Simulate genomic position data (e.g., methylation along chromosome)
set.seed(123)
n <- 1000
positions <- sort(runif(n, 0, 1e6)) # Genomic positions
methylation <- 0.5 + 0.3 * sin(positions / 1e5) + rnorm(n, sd = 0.1)
methylation <- pmax(0, pmin(1, methylation)) # Bound to [0, 1]

# Smooth methylation profile
result_meth <- fastlowess(
  positions, methylation,
  fraction = 0.1,
  iterations = 3,
  confidence_intervals = 0.95
)

# Plot
plot(positions, methylation,
  pch = ".", col = "gray",
  main = "Methylation Profile Smoothing",
  xlab = "Genomic Position (bp)", ylab = "Methylation Level"
)
lines(result_meth$x, result_meth$y, col = "blue", lwd = 2)
lines(result_meth$x, result_meth$confidence_lower, col = "blue", lty = 2)
lines(result_meth$x, result_meth$confidence_upper, col = "blue", lty = 2)
```

## Gene Expression Time Series

Smoothing temporal gene expression data:

```{r expression_example}
# Simulate gene expression over time
time_points <- seq(0, 24, by = 0.5) # Hours
expression <- 100 * (1 + 0.5 * sin(time_points * pi / 12)) +
  rnorm(length(time_points), sd = 10)

# Smooth with prediction intervals
result_expr <- fastlowess(
  time_points, expression,
  fraction = 0.3,
  iterations = 3,
  prediction_intervals = 0.95,
  return_diagnostics = TRUE
)

# Plot
plot(time_points, expression,
  pch = 16, col = "gray",
  main = "Gene Expression Time Course",
  xlab = "Time (hours)", ylab = "Expression Level"
)
lines(result_expr$x, result_expr$y, col = "red", lwd = 2)
lines(result_expr$x, result_expr$prediction_lower, col = "red", lty = 2)
lines(result_expr$x, result_expr$prediction_upper, col = "red", lty = 2)

# Print diagnostics
cat("RÂ²:", result_expr$diagnostics$r_squared, "\n")
cat("RMSE:", result_expr$diagnostics$rmse, "\n")
```

# Advanced Features

## Cross-Validation for Parameter Selection

Automatically select the optimal smoothing fraction:

```{r cv_example}
# Test multiple fractions
result_cv <- fastlowess(
  x, y,
  cv_fractions = c(0.1, 0.2, 0.3, 0.5, 0.7),
  cv_method = "kfold",
  cv_k = 5
)

cat("Optimal fraction:", result_cv$fraction_used, "\n")
cat("CV scores:", result_cv$cv_scores, "\n")
```

## Streaming Processing for Large Datasets

For datasets too large to fit in memory:

```{r streaming_example, eval=FALSE}
# Large dataset example
n_large <- 100000
x_large <- seq(0, 100, length.out = n_large)
y_large <- sin(x_large / 10) + rnorm(n_large, sd = 0.1)

# Streaming smoothing
result_stream <- fastlowess_streaming(
  x_large, y_large,
  fraction = 0.1,
  chunk_size = 5000,
  overlap = 500
)
```

## Online Processing for Real-Time Data

For real-time data streams:

```{r online_example}
# Simulate sensor data arriving sequentially
sensor_times <- 1:100
sensor_values <- 20 + 5 * sin(sensor_times / 10) + rnorm(100, sd = 1)

# Online smoothing with sliding window
result_online <- fastlowess_online(
  sensor_times, sensor_values,
  window_capacity = 25,
  fraction = 0.3,
  min_points = 10
)

plot(sensor_times, sensor_values,
  pch = 16, col = "gray",
  main = "Online Sensor Data Smoothing",
  xlab = "Time", ylab = "Sensor Value"
)
lines(result_online$x, result_online$y, col = "green", lwd = 2)
```

# Performance Comparison

`rfastlowess` provides significant speed improvements over standard
implementations:

- **1.5-6.8x faster** than R's `stats::lowess` (serial mode)
- **Up to 6.8x faster** with parallel execution on large datasets
- Consistent performance across different data sizes and parameter settings

For detailed benchmarks, see the benchmark section in the
[package repository][bench_url].

[bench_url]: https://github.com/thisisamirv/rfastlowess/tree/bench/benchmarks

# Parameter Guidelines

## Fraction (Smoothing Span)

- **0.1-0.3**: Fine detail, captures rapid changes (may be noisy)
- **0.3-0.5**: Moderate smoothing (recommended for most cases)
- **0.5-0.7**: Heavy smoothing, emphasizes trends
- **Default: 0.67** (Cleveland's original choice)

## Robustness Iterations

- **0**: No robustness (fastest, sensitive to outliers)
- **1-3**: Moderate robustness (recommended)
- **4-6**: Strong robustness (for contaminated data)

## Kernel Functions

- **tricube** (default): Best all-around performance
- **epanechnikov**: Optimal MSE properties
- **gaussian**: Very smooth, infinite support

# Session Info

```{r session_info}
sessionInfo()
```

# References

- Cleveland, W.S. (1979). "Robust Locally Weighted Regression and Smoothing
    Scatterplots". *Journal of the American Statistical Association*, 74(368),
    829-836.
- Cleveland, W.S. (1981). "LOWESS: A Program for Smoothing Scatterplots".
    *The American Statistician*, 35(1), 54.
