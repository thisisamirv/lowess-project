name: Release Conda

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (without v prefix, e.g., 0.1.2)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-feedstock:
    name: Update conda-forge feedstock
    runs-on: ubuntu-latest

    steps:
      - name: Check required secrets
        env:
          CONDA_FORGE_TOKEN: ${{ secrets.CONDA_FORGE_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$CONDA_FORGE_TOKEN" ]; then
            echo "⚠️ Warning: CONDA_FORGE_TOKEN secret is not set."
            echo "If this is a fork or the built-in GITHUB_TOKEN lacks permissions to fork/PR on conda-forge,"
            echo "please add a Personal Access Token (PAT) with 'repo' permissions as a secret named CONDA_FORGE_TOKEN."
            
            if [ -n "$GITHUB_TOKEN" ]; then
              echo "✅ Falling back to GITHUB_TOKEN..."
            else
              echo "❌ Error: Neither CONDA_FORGE_TOKEN nor GITHUB_TOKEN are available."
              exit 1
            fi
          else
            echo "✅ CONDA_FORGE_TOKEN is configured."
          fi

      - name: Determine version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Updating to version: $VERSION"

      - name: Calculate SHA256 from GitHub Release
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          URL="https://github.com/thisisamirv/lowess-project/archive/v${VERSION}.tar.gz"
          echo "Fetching SHA256 from $URL..."

          # We can trust that if the release triggered this, the tarball exists.
          # But let's confirm it's not a 404
          HTTP_CODE=$(curl -o /dev/null -sL -w "%{http_code}\n" "$URL")
          if [ "$HTTP_CODE" != "200" ]; then
             echo "❌ Error: GitHub Release tarball not found (HTTP $HTTP_CODE)."
             exit 1
          fi

          SHA256=$(curl -sL "$URL" | sha256sum | awk '{print $1}')

          if [ -z "$SHA256" ]; then
            echo "❌ Failed to calculate SHA256."
            exit 1
          fi

          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Clone feedstock fork
        env:
          GH_TOKEN: ${{ secrets.CONDA_FORGE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone the user's fork (assumes fork already exists at thisisamirv/fastlowess-feedstock)
          # If you need to use a different account, update this URL
          git clone "https://x-access-token:${GH_TOKEN}@github.com/thisisamirv/fastlowess-feedstock.git"

          cd fastlowess-feedstock

          # Add conda-forge as upstream and fetch latest
          git remote add upstream https://github.com/conda-forge/fastlowess-feedstock.git
          git fetch upstream
          git checkout main
          git merge upstream/main --no-edit || true

      - name: Update recipe
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SHA256: ${{ steps.sha256.outputs.sha256 }}
          # Use a multi-line string for the build script
          BUILD_R_SCRIPT: |
            #!/bin/bash
            set -ex

            echo "=== System Info ==="
            uname -a
            python3 --version || python --version || true

            # Determine R executable
            R_EXE=${R:-R}
            $R_EXE --version

            # Use python provided by conda build
            PYTHON_EXE=$(which python3 || which python || echo "python")
            echo "Using Python: $PYTHON_EXE"

            # 1. Extract existing vendor dependencies if present
            # This contains external crates (extendr-api, etc.)
            if [ -f bindings/r/src/vendor.tar.xz ]; then
              echo "Extracting vendor.tar.xz..."
              (cd bindings/r/src && tar -xf vendor.tar.xz)
            fi

            # 2. Update local crates in vendor directory
            # This ensures we build with the latest local changes
            mkdir -p bindings/r/src/vendor
            cp -rvL crates/fastLowess bindings/r/src/vendor/
            cp -rvL crates/lowess bindings/r/src/vendor/

            # Clean up target/locks from vendored sources
            rm -rf bindings/r/src/vendor/*/target
            rm -f bindings/r/src/vendor/*/Cargo.lock

            # 3. Patch and Isolate (remove workspace inheritance)
            echo "Running preparation scripts..."
            $PYTHON_EXE dev/prepare_cargo.py clean bindings/r/src/Cargo.toml
            $PYTHON_EXE dev/patch_vendor_crates.py Cargo.toml bindings/r/src/vendor/
            $PYTHON_EXE dev/prepare_cargo.py isolate bindings/r/src/Cargo.toml

            # Remove main lock file to prevent path conflicts
            rm -f bindings/r/src/Cargo.lock

            # 4. Final R build
            echo "Starting R package installation..."
            cd bindings/r
            $R_EXE CMD INSTALL --build .
        run: |
          set -x
          cd fastlowess-feedstock

          # Create a new branch
          BRANCH="update-to-v$VERSION"
          git checkout -b "$BRANCH"

          # Update version and SHA256 in meta.yaml
          sed -i "s/{% set version = \".*\" %}/{% set version = \"$VERSION\" %}/" recipe/meta.yaml
          sed -i "s/sha256: .*/sha256: $SHA256/" recipe/meta.yaml
          sed -i "s/number: .*/number: 0/" recipe/meta.yaml

          # Fix R package name in tests
          sed -i "s/library('fastlowess')/library('rfastlowess')/g" recipe/meta.yaml

          # Add python dependencies to build requirements for R package
          # Use a single, reliable one-liner for substitution
          sed -i '/name: r-fastlowess/,/test:/ s/- make  # \[unix\]/- make  # [unix]\n        - python\n        - tomli\n        - tomli-w/' recipe/meta.yaml

          # Save the build script from the env var
          echo "$BUILD_R_SCRIPT" > recipe/build_r.sh
          chmod +x recipe/build_r.sh

          # Show the changes for debugging
          echo "=== Updated meta.yaml (r-fastlowess section) ==="
          sed -n '/name: r-fastlowess/,/test:/p' recipe/meta.yaml
          echo "=== Updated build_r.sh ==="
          cat recipe/build_r.sh
          echo "=========================="

          # Commit changes
          git add recipe/
          git commit -m "Update to version $VERSION"

      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: smithy
          create-args: >-
            conda-smithy
          cache-environment: true

      - name: Rerender feedstock
        shell: bash -l {0}
        run: |
          cd fastlowess-feedstock
          conda smithy rerender --commit
          echo "✅ Rerendered successfully!"

      - name: Push and create PR
        env:
          GH_TOKEN: ${{ secrets.CONDA_FORGE_TOKEN || secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          cd fastlowess-feedstock

          BRANCH="update-to-v$VERSION"

          # Push to fork
          git push -u origin "$BRANCH" --force

          # Create PR to conda-forge/fastlowess-feedstock
          PR_BODY="## Update fastlowess to version $VERSION

          This PR was automatically generated by the [conda-forge-update workflow](https://github.com/${{ github.repository }}/actions/workflows/conda-forge-update.yml).

          ### Changes
          - Updated version to $VERSION
          - Updated SHA256 hash
          - Reset build number to 0
          - Automatically rerendered with conda-smithy

          ### Checklist
          - [x] Version updated
          - [x] SHA256 hash updated
          - [x] Build number reset to 0
          - [x] Feedstock rerendered"

          gh pr create \
            --repo conda-forge/fastlowess-feedstock \
            --head "${{ github.repository_owner }}:$BRANCH" \
            --base main \
            --title "Update to version $VERSION" \
            --body "$PR_BODY"

          echo "✅ PR created successfully!"
