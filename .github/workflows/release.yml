name: Release

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: read

env:
  # Build wheels for Python 3.8 through 3.14
  PYTHON_VERSIONS: "cp38 cp39 cp310 cp311 cp312 cp313 cp314"

jobs:
  # ============================================================================
  # BUILD WHEELS - Linux x86_64
  # ============================================================================
  linux-x86_64:
    name: Build Linux x86_64 (py${{ matrix.python }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/python
          target: x86_64
          args: --release --out dist --interpreter python${{ matrix.python }}
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-x86_64-py${{ matrix.python }}
          path: bindings/python/dist

  # ============================================================================
  # BUILD WHEELS - Linux ARM64 (aarch64)
  # ============================================================================
  linux-aarch64:
    name: Build Linux ARM64 (py${{ matrix.python }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/python
          target: aarch64
          args: --release --out dist --interpreter python${{ matrix.python }}
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-aarch64-py${{ matrix.python }}
          path: bindings/python/dist

  # ============================================================================
  # BUILD WHEELS - macOS x86_64 (Intel)
  # ============================================================================
  macos-x86_64:
    name: Build macOS x86_64 (py${{ matrix.python }})
    runs-on: macos-15-intel
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/python
          target: x86_64
          args: --release --out dist

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-x86_64-py${{ matrix.python }}
          path: bindings/python/dist

  # ============================================================================
  # BUILD WHEELS - macOS ARM64 (Apple Silicon)
  # ============================================================================
  macos-aarch64:
    name: Build macOS ARM64 (py${{ matrix.python }})
    runs-on: macos-14 # Apple Silicon runner
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/python
          target: aarch64
          args: --release --out dist

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-aarch64-py${{ matrix.python }}
          path: bindings/python/dist

  # ============================================================================
  # BUILD WHEELS - Windows x86_64
  # ============================================================================
  windows-x86_64:
    name: Build Windows x86_64 (py${{ matrix.python }})
    runs-on: windows-latest
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/python
          target: x86_64
          args: --release --out dist

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-x86_64-py${{ matrix.python }}
          path: bindings/python/dist

  # ============================================================================
  # BUILD SOURCE DISTRIBUTION
  # ============================================================================
  sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/python
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: bindings/python/dist

  # ============================================================================
  # PUBLISH TO PYPI
  # ============================================================================
  publish:
    name: Publish to PyPI
    needs:
      - linux-x86_64
      - linux-aarch64
      - macos-x86_64
      - macos-aarch64
      - windows-x86_64
      - sdist
    runs-on: ubuntu-latest
    # Only publish on release events (not manual workflow_dispatch)
    if: github.event_name == 'release'
    environment: pypi
    permissions:
      id-token: write # Required for trusted publishing
      contents: read # Required for checkout and metadata access

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bindings/python/dist
          merge-multiple: true

      - name: List artifacts
        run: ls -la bindings/python/dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: bindings/python/dist/
