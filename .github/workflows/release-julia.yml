name: Release Julia

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (without v prefix, e.g., 0.1.2)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-yggdrasil:
    name: Update Yggdrasil
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Check required secrets
        env:
          YGGDRASIL_TOKEN: ${{ secrets.YGGDRASIL_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$YGGDRASIL_TOKEN" ]; then
            echo "⚠️ Warning: YGGDRASIL_TOKEN secret is not set."
            echo "Please add a PAT with 'repo' permissions as a secret named YGGDRASIL_TOKEN."
            
            if [ -n "$GITHUB_TOKEN" ]; then
              echo "✅ Falling back to GITHUB_TOKEN (might fail if no fork permissions)..."
            else
              echo "❌ Error: No tokens available."
              exit 1
            fi
          else
            echo "✅ YGGDRASIL_TOKEN is configured."
          fi

      - name: Checkout Source (Lowess Project)
        uses: actions/checkout@v4
        with:
          path: lowess-project

      - name: Determine Version and Commit
        id: meta
        run: |
          cd lowess-project
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
            COMMIT="${{ github.sha }}"
            echo "Triggered by release: $VERSION ($COMMIT)"
          else
            VERSION="${{ github.event.inputs.version }}"
            COMMIT=$(git rev-parse HEAD)
            echo "Triggered manually: $VERSION ($COMMIT)"
          fi

          # Validate version format
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid version format: $VERSION (expected x.y.z)"
            exit 1
          fi

          # Validate commit hash
          if ! echo "$COMMIT" | grep -qE '^[0-9a-f]{40}$'; then
            echo "❌ Invalid commit hash: $COMMIT (expected 40 hex chars)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Prepare Build Script
        id: script
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          COMMIT: ${{ steps.meta.outputs.commit }}
        run: |
          # Read the template from the source repo
          CONTENT=$(cat lowess-project/dev/build_tarballs_julia.jl)

          # Replace Version
          CONTENT=$(echo "$CONTENT" | sed "s/version = v\"[^\"]*\"/version = v\"$VERSION\"/")

          # Replace Commit Hash (40 hex characters)
          CONTENT=$(echo "$CONTENT" | sed "s/\"[0-9a-f]\{40\}\"/\"$COMMIT\"/")

          # Verify replacements
          echo "=== Updated Script (first 30 lines) ==="
          echo "$CONTENT" | head -n 30
          echo "..."

          # Verify version was replaced
          if ! echo "$CONTENT" | grep -q "version = v\"$VERSION\""; then
            echo "❌ Failed to update version in script"
            exit 1
          fi

          # Verify commit was replaced
          if ! echo "$CONTENT" | grep -q "\"$COMMIT\""; then
            echo "❌ Failed to update commit hash in script"
            exit 1
          fi

          # Save to a temporary file
          echo "$CONTENT" > build_tarballs.jl
          echo "✅ Build script prepared successfully"

      - name: Check Yggdrasil Fork Exists
        id: fork
        env:
          GH_TOKEN: ${{ secrets.YGGDRASIL_TOKEN || secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        run: |
          echo "Checking if $OWNER/Yggdrasil fork exists..."
          if gh repo view "$OWNER/Yggdrasil" > /dev/null 2>&1; then
            echo "✅ Fork exists: $OWNER/Yggdrasil"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Fork does not exist. Attempting to fork..."
            gh repo fork JuliaPackaging/Yggdrasil --clone=false || {
              echo "❌ Failed to fork Yggdrasil. Please fork manually."
              exit 1
            }
            echo "✅ Fork created successfully"
            echo "exists=true" >> $GITHUB_OUTPUT
            # Wait for fork to propagate
            sleep 10
          fi

      - name: Clone Yggdrasil Fork
        env:
          GH_TOKEN: ${{ secrets.YGGDRASIL_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          OWNER="${{ github.repository_owner }}"

          echo "Cloning https://github.com/$OWNER/Yggdrasil.git..."
          git clone "https://x-access-token:${GH_TOKEN}@github.com/$OWNER/Yggdrasil.git" yggdrasil-fork

          cd yggdrasil-fork
          # Add upstream and sync
          git remote add upstream https://github.com/JuliaPackaging/Yggdrasil.git
          git fetch upstream
          git checkout master
          git merge upstream/master --no-edit || git reset --hard upstream/master
          git push origin master --force || true
          echo "✅ Fork synced with upstream"

      - name: Check for Existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.YGGDRASIL_TOKEN || secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.meta.outputs.version }}
          OWNER: ${{ github.repository_owner }}
        run: |
          # Check if a PR already exists for this version
          EXISTING_PR=$(gh pr list \
            --repo JuliaPackaging/Yggdrasil \
            --head "$OWNER:FastLOWESS-v$VERSION" \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "⚠️ PR #$EXISTING_PR already exists for v$VERSION"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "✅ No existing PR found for v$VERSION"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.YGGDRASIL_TOKEN || secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.meta.outputs.version }}
          COMMIT: ${{ steps.meta.outputs.commit }}
          OWNER: ${{ github.repository_owner }}
        run: |
          cd yggdrasil-fork

          BRANCH="FastLOWESS-v$VERSION"

          # Delete branch if it exists (for re-runs)
          git push origin --delete "$BRANCH" 2>/dev/null || true

          git checkout -b "$BRANCH"

          # Create directory structure F/fastlowess
          mkdir -p F/fastlowess

          # Copy the prepared script
          cp ../build_tarballs.jl F/fastlowess/build_tarballs.jl

          # Commit
          git add F/fastlowess/build_tarballs.jl
          git commit -m "[FastLOWESS] v$VERSION"

          # Push to fork
          git push -u origin "$BRANCH"

          # Create PR
          PR_BODY="## FastLOWESS v$VERSION

          Automated update via GitHub Actions from [${{ github.repository }}](https://github.com/${{ github.repository }}).

          - **Version**: $VERSION
          - **Source Commit**: [\`${COMMIT:0:7}\`](https://github.com/${{ github.repository }}/commit/$COMMIT)
          - **Workflow Run**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "

          PR_URL=$(gh pr create \
            --repo JuliaPackaging/Yggdrasil \
            --head "$OWNER:$BRANCH" \
            --base master \
            --title "[FastLOWESS] v$VERSION" \
            --body "$PR_BODY")

          echo "✅ Pull Request created: $PR_URL"

      - name: Update Existing PR
        if: steps.check-pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.YGGDRASIL_TOKEN || secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.meta.outputs.version }}
          COMMIT: ${{ steps.meta.outputs.commit }}
          OWNER: ${{ github.repository_owner }}
          PR_NUMBER: ${{ steps.check-pr.outputs.pr_number }}
        run: |
          cd yggdrasil-fork

          BRANCH="FastLOWESS-v$VERSION"

          # Checkout existing branch
          git fetch origin "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH"
          git checkout "$BRANCH" || git checkout -b "$BRANCH"

          # Update the script
          mkdir -p F/fastlowess
          cp ../build_tarballs.jl F/fastlowess/build_tarballs.jl

          # Commit and push
          git add F/fastlowess/build_tarballs.jl
          git commit -m "[FastLOWESS] v$VERSION - update" --allow-empty
          git push origin "$BRANCH" --force

          echo "✅ Updated existing PR #$PR_NUMBER"

      - name: Summary
        run: |
          echo "## Julia JLL Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ steps.meta.outputs.commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A PR has been created/updated on Yggdrasil. Once merged:" >> $GITHUB_STEP_SUMMARY
          echo "1. The JLL will be built for all platforms" >> $GITHUB_STEP_SUMMARY
          echo "2. A registration PR will be auto-created on General" >> $GITHUB_STEP_SUMMARY
          echo "3. After ~20 minutes, the package will be available" >> $GITHUB_STEP_SUMMARY

  trigger-registration:
    name: Trigger Registration
    needs: update-yggdrasil
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Trigger JuliaRegistrator
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.YGGDRASIL_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const commit_sha = context.sha;
            console.log(`Triggering registration for commit: ${commit_sha}`);
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commit_sha,
              body: '@JuliaRegistrator register subdir=bindings/julia/julia'
            });
